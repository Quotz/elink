<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#7CB342">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>elink - EV Charging</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div id="app">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <div class="dual-logo">
          <img src="/E-Link-1024x500.png" alt="eLink" class="logo">
          <span class="logo-divider"></span>
          <img src="/inova-logo.png" alt="INOVA" class="logo logo-inova">
        </div>
        <span class="dot offline" id="connectionDot" style="margin-left:4px"></span>
      </div>
      <div class="header-right" id="headerRight">
        <!-- User menu injected by JS -->
      </div>
    </header>

    <!-- Search Bar -->
    <div class="search-bar" id="searchBar">
      <input type="text" id="searchInput" data-i18n="search_stations" placeholder="Search stations..." autocomplete="off">
      <div class="search-results hidden" id="searchResults"></div>
    </div>

    <!-- Map View -->
    <div id="map"></div>

    <!-- Station Panel (slides up when station selected) -->
    <div class="panel" id="stationPanel">
      <div class="panel-top">
        <div class="panel-handle" onclick="closePanel()"></div>
        <button class="panel-close-btn" onclick="closePanel()" aria-label="Close">&times;</button>
      </div>

      <!-- Station Info -->
      <div class="station-header">
        <h2 id="stationName">Station</h2>
        <span class="status-badge" id="stationStatus">Offline</span>
      </div>
      
      <div class="station-details">
        <div class="detail-row">
          <span class="label" data-i18n="power_output">Power Output</span>
          <span class="value" id="stationPower">-- kW</span>
        </div>
        <div class="detail-row">
          <span class="label" data-i18n="connector_type">Connector Type</span>
          <span class="value" data-i18n="type2_ac">Type 2 AC</span>
        </div>
        <div class="detail-row">
          <span class="label" data-i18n="price_per_kwh">Price per kWh</span>
          <span class="value" id="stationPrice">--</span>
        </div>
        <div class="detail-row">
          <span class="label" data-i18n="address">Address</span>
          <span class="value" id="stationAddress">--</span>
        </div>
      </div>

      <!-- Connection Phase Overlay (shown between payment and active charging) -->
      <div class="connection-phase-overlay hidden" id="connectionPhaseOverlay"></div>

      <!-- Charging Status (shown during active session) -->
      <div class="charging-display hidden" id="chargingDisplay">
        <!-- Battery Indicator -->
        <div class="battery-indicator">
          <div class="battery-icon">
            <div class="battery-fill" id="batteryFill" style="width: 0%"></div>
          </div>
          <div class="battery-info">
            <div class="battery-percent" id="batteryPercent">0%</div>
            <div class="battery-label" data-i18n="battery_level">Battery Level</div>
          </div>
        </div>

        <!-- Charging Stats 2x2 Grid -->
        <div class="charging-stats-grid">
          <div class="stat-card">
            <div class="stat-card-icon">&#9889;</div>
            <span class="stat-value" id="currentPower">0</span>
            <span class="stat-unit">kW</span>
            <span class="stat-label" data-i18n="power">Power</span>
          </div>
          <div class="stat-card primary">
            <div class="stat-card-icon">&#128267;</div>
            <span class="stat-value" id="energyDelivered">0.00</span>
            <span class="stat-unit">kWh</span>
            <span class="stat-label" data-i18n="energy">Energy</span>
          </div>
          <div class="stat-card">
            <div class="stat-card-icon">&#9201;</div>
            <span class="stat-value" id="chargingTime">0:00</span>
            <span class="stat-unit"></span>
            <span class="stat-label" data-i18n="duration">Duration</span>
          </div>
          <div class="stat-card cost">
            <div class="stat-card-icon">&#128176;</div>
            <span class="stat-value" id="costAmount">&euro;0.00</span>
            <span class="stat-unit"></span>
            <span class="stat-label" data-i18n="estimated_cost">Estimated Cost</span>
          </div>
        </div>

        <!-- Technical Details (collapsible) -->
        <div class="technical-data" id="technicalData" style="display: none;">
          <div class="tech-header" onclick="toggleTechnicalData()">
            <span data-i18n="technical_data">Technical Data</span>
            <span class="toggle-icon" id="techToggleIcon">&#9660;</span>
          </div>
          <div class="tech-content" id="techContent" style="display: none;">
            <div class="tech-row">
              <span class="tech-label" data-i18n="voltage">Voltage</span>
              <span class="tech-value" id="techVoltage">-- V</span>
            </div>
            <div class="tech-row">
              <span class="tech-label" data-i18n="current">Current</span>
              <span class="tech-value" id="techCurrent">-- A</span>
            </div>
            <div class="tech-row">
              <span class="tech-label" data-i18n="temperature">Temperature</span>
              <span class="tech-value" id="techTemperature">-- &deg;C</span>
            </div>
            <div class="tech-row">
              <span class="tech-label" data-i18n="max_power">Max Power</span>
              <span class="tech-value" id="techMaxPower">-- kW</span>
            </div>
            <div class="tech-row">
              <span class="tech-label" data-i18n="data_age">Data Age</span>
              <span class="tech-value" id="techDataAge">-- s</span>
            </div>
          </div>
        </div>

        <!-- Charging Animation -->
        <div class="charging-animation">
          <div class="pulse"></div>
          <span data-i18n="charging_in_progress">Charging in progress...</span>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="actions" id="actions">
        <button class="btn btn-primary" id="startBtn" onclick="showPayment()">
          <span data-i18n="start_charging">Start Charging</span>
        </button>
        <button class="btn btn-danger hidden" id="stopBtn" onclick="stopCharging()">
          <span data-i18n="stop_charging">Stop Charging</span>
        </button>
        <button class="btn btn-secondary" id="navigateBtn" onclick="navigateToStation()" style="background:#2196F3;color:white">
          <span data-i18n="navigate">Navigate</span>
        </button>
      </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal hidden" id="paymentModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 data-i18n="payment">Payment</h3>
          <button class="close-btn" onclick="closePayment()">&times;</button>
        </div>
        <div class="modal-body">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;padding:10px 14px;background:#f0faf0;border-radius:8px;font-size:13px;color:#2e7d32">
            <span style="font-size:16px">&#128274;</span> Secure payment powered by eLink
          </div>

          <div class="form-group">
            <label data-i18n="card_number">Card Number</label>
            <div style="position:relative">
              <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456"
                     maxlength="19" inputmode="numeric" autocomplete="cc-number"
                     style="padding-right:60px">
              <span id="cardBrandIcon" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);font-size:24px;opacity:0.6"></span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label data-i18n="expiry_date">Expiry Date</label>
              <input type="text" id="cardExpiry" placeholder="MM / YY" maxlength="5" autocomplete="cc-exp">
            </div>
            <div class="form-group">
              <label data-i18n="security_code">Security Code</label>
              <input type="password" id="cardCvv" placeholder="CVV" maxlength="4" inputmode="numeric" autocomplete="cc-csc">
            </div>
          </div>

          <div id="cardError" style="display:none;color:#c62828;font-size:13px;margin-bottom:12px;padding:8px 12px;background:#ffebee;border-radius:8px"></div>

          <button class="btn btn-primary btn-full" id="payBtn" onclick="processPayment()" style="position:relative;overflow:hidden">
            <span id="payBtnText" data-i18n="authorize_start">Authorize & Start Charging</span>
            <span id="payBtnSpinner" style="display:none;position:absolute;inset:0;background:#689F38;display:none;align-items:center;justify-content:center">
              Processing...
            </span>
          </button>

          <div style="text-align:center;margin-top:14px;font-size:11px;color:#aaa">
            <span data-i18n="cards_accepted">Visa, Mastercard, and Maestro accepted</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Session Summary Modal -->
    <div class="modal hidden" id="summaryModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 data-i18n="session_complete">Session Complete</h3>
          <button class="close-btn" onclick="closeSummary()">&times;</button>
        </div>
        <div class="modal-body summary-content">
          <div class="summary-icon">⚡</div>
          <h3 class="summary-title" data-i18n="charging_complete">Charging Complete!</h3>
          <p class="summary-subtitle" data-i18n="thank_you">Thank you for charging with elink</p>
          
          <div class="summary-stats">
            <div class="summary-stat">
              <span class="summary-stat-label" data-i18n="energy_delivered">Energy Delivered</span>
              <span class="summary-stat-value" id="summaryEnergy">0.00 kWh</span>
            </div>
            <div class="summary-stat">
              <span class="summary-stat-label" data-i18n="charging_duration">Charging Duration</span>
              <span class="summary-stat-value" id="summaryDuration">0:00</span>
            </div>
            <div class="summary-stat">
              <span class="summary-stat-label" data-i18n="average_power">Average Power</span>
              <span class="summary-stat-value" id="summaryAvgPower">0 kW</span>
            </div>
            <div class="summary-stat">
              <span class="summary-stat-label" data-i18n="total_cost">Total Cost</span>
              <span class="summary-stat-value highlight" id="summaryCost">€0.00</span>
            </div>
          </div>
          
          <button class="btn btn-primary btn-full" onclick="closeSummary()">
            <span data-i18n="done">Done</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast hidden" id="toast">
      <span class="toast-icon">ℹ️</span>
      <span id="toastMessage"></span>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav" id="bottomNav">
      <button class="nav-item active" onclick="navMap()" id="navMapBtn">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
        <span data-i18n="map">Map</span>
      </button>
      <button class="nav-item" onclick="navSearch()" id="navSearchBtn">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <span data-i18n="search">Search</span>
      </button>
      <button class="nav-item" onclick="navProfile()" id="navProfileBtn">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        <span id="navProfileLabel" data-i18n="profile">Profile</span>
      </button>
    </nav>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="/i18n.js"></script>
  <script src="/js/state.js"></script>
  <script src="/js/toast.js"></script>
  <script src="/js/map.js"></script>
  <script src="/js/citrine.js"></script>
  <script src="/js/station.js"></script>
  <script src="/js/charging.js"></script>
  <script src="/js/payment.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/reservation.js"></script>
  <script src="/js/search.js"></script>
  <script src="/js/websocket.js"></script>
  <script src="/js/pwa.js"></script>
  <script src="/js/init.js"></script>
</body>
</html>
