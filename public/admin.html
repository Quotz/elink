<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#7CB342">
  <title>Admin Panel - eLink</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #333;
    }

    .admin-logo-bar {
      background: white;
      padding: 10px 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .admin-header {
      background: linear-gradient(135deg, #7CB342, #689F38);
      color: white;
      padding: 14px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .admin-header h1 {
      font-size: 22px;
      margin: 0;
    }

    .admin-logos {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .admin-logos img {
      height: 32px;
      width: auto;
    }
    .admin-logos .logo-divider {
      width: 1px;
      height: 22px;
      background: #d1d5db;
      flex-shrink: 0;
    }
    .admin-logos .logo-inova {
      height: 26px;
    }

    .header-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }

    .btn-primary {
      background: white;
      color: #7CB342;
    }

    .btn-success {
      background: #7CB342;
      color: white;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-secondary {
      background: #757575;
      color: white;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 13px;
    }

    /* Dashboard Stats */
    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .stat-card h3 {
      font-size: 13px;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #333;
    }

    .stat-card.revenue .stat-value {
      color: #7CB342;
    }

    .stat-card.users .stat-value {
      color: #2196F3;
    }

    .stat-card.reservations .stat-value {
      color: #FF9800;
    }

    .stat-card.charging .stat-value {
      color: #4CAF50;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 5px;
      background: white;
      padding: 10px 20px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .tab {
      padding: 12px 20px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .tab:hover {
      color: #333;
    }

    .tab.active {
      color: #7CB342;
      border-bottom-color: #7CB342;
    }

    .tab-content {
      display: none;
      padding: 20px;
    }

    .tab-content.active {
      display: block;
    }

    /* Tables */
    .data-table {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
    }

    .table-header h2 {
      font-size: 18px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 15px;
      font-weight: 600;
      color: #666;
      font-size: 13px;
      text-transform: uppercase;
      background: #f9f9f9;
    }

    td {
      padding: 15px;
      border-top: 1px solid #f0f0f0;
    }

    tbody tr:hover {
      background: #fafafa;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-online {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status-offline {
      background: #f5f5f5;
      color: #666;
    }

    .status-charging {
      background: #fff3e0;
      color: #ef6c00;
    }

    .status-active {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status-completed {
      background: #e3f2fd;
      color: #1565c0;
    }

    .status-cancelled {
      background: #ffebee;
      color: #c62828;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 20px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #888;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #555;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .hidden { display: none !important; }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }

    @media (max-width: 768px) {
      .admin-logo-bar {
        padding: 8px 16px;
      }
      .admin-header {
        padding: 12px 16px;
        flex-direction: column;
        align-items: flex-start;
      }
      .admin-header h1 {
        font-size: 18px;
      }
      .header-actions {
        flex-direction: column;
        gap: 10px;
      }
      .dashboard-stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-bottom: 20px;
      }
      .stat-card {
        padding: 14px;
      }
      .stat-value {
        font-size: 24px;
      }
      .stat-card h3 {
        font-size: 11px;
      }
      .tabs {
        overflow-x: auto;
        flex-wrap: nowrap;
        padding: 8px 12px 0;
        -webkit-overflow-scrolling: touch;
      }
      .tab {
        white-space: nowrap;
        padding: 10px 14px;
        font-size: 13px;
        min-height: 44px;
      }
      .tab-content {
        padding: 12px;
      }

      /* Card layout for tables on mobile */
      table, thead, tbody, th, tr {
        display: block;
      }
      thead {
        display: none;
      }
      tbody tr {
        background: white;
        border-radius: 10px;
        margin-bottom: 10px;
        padding: 14px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        border: 1px solid #f0f0f0;
      }
      td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-top: none;
        border-bottom: 1px solid #f5f5f5;
        font-size: 14px;
      }
      td:last-child {
        border-bottom: none;
        padding-top: 10px;
      }
      td::before {
        content: attr(data-label);
        font-weight: 600;
        color: #666;
        font-size: 12px;
        text-transform: uppercase;
        flex-shrink: 0;
        margin-right: 12px;
      }
      .data-table {
        background: transparent;
        box-shadow: none;
      }
      .table-header {
        padding: 14px 4px;
        border-bottom: none;
      }
      .table-header h2 {
        font-size: 16px;
      }
      .btn { min-height: 44px; }
      .btn-small { min-height: 36px; padding: 8px 14px; }
      .modal-content {
        max-width: 100%;
        border-radius: 16px 16px 0 0;
        max-height: 95vh;
      }
      .modal {
        align-items: flex-end;
        padding: 0;
      }
      .form-group input, .form-group select {
        padding: 12px;
        font-size: 16px;
        min-height: 48px;
      }
    }

    @media (max-width: 480px) {
      .dashboard-stats {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .stat-card {
        padding: 12px;
      }
      .stat-value {
        font-size: 22px;
      }
    }
  </style>
</head>
<body>
  <div class="admin-logo-bar">
    <div class="admin-logos">
      <img src="/E-Link-1024x500.png" alt="eLink">
      <span class="logo-divider"></span>
      <img src="/inova-logo.png" alt="INOVA" class="logo-inova">
    </div>
  </div>
  <div class="admin-header">
    <h1>‚ö° Admin Panel</h1>
    <div class="header-actions">
      <div style="display: flex; gap: 10px;">
        <span style="font-size: 14px; opacity: 0.9;">Welcome, Admin</span>
      </div>
      <div>
        <a href="/" class="btn btn-primary">‚Üê User App</a>
        <button class="btn btn-secondary" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <div style="max-width: 1400px; margin: 0 auto; padding: 20px;">
    <!-- Dashboard Stats -->
    <div class="dashboard-stats">
      <div class="stat-card revenue">
        <h3>üí∞ Today's Revenue</h3>
        <div class="stat-value" id="todayRevenue">‚Ç¨0.00</div>
      </div>
      <div class="stat-card users">
        <h3>üë• Total Users</h3>
        <div class="stat-value" id="totalUsers">0</div>
      </div>
      <div class="stat-card">
        <h3>üîå Total Stations</h3>
        <div class="stat-value" id="totalStations">0</div>
      </div>
      <div class="stat-card charging">
        <h3>‚ö° Now Charging</h3>
        <div class="stat-value" id="chargingCount">0</div>
      </div>
      <div class="stat-card reservations">
        <h3>üìÖ Active Reservations</h3>
        <div class="stat-value" id="activeReservations">0</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('stations')">üîå Stations</button>
      <button class="tab" onclick="switchTab('users')">üë• Users</button>
      <button class="tab" onclick="switchTab('reservations')">üìÖ Reservations</button>
      <button class="tab" onclick="switchTab('transactions')">üí≥ Transactions</button>
      <button class="tab" onclick="switchTab('demo')">üéÆ Demo</button>
    </div>

    <!-- Stations Tab -->
    <div class="tab-content active" id="stationsTab">
      <div class="data-table">
        <div class="table-header">
          <h2>Charging Stations</h2>
          <button class="btn btn-success" onclick="openStationModal()">+ Add Station</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Status</th>
              <th>Power</th>
              <th>Active Session</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="stationsTable">
            <tr><td colspan="6" class="empty-state">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Users Tab -->
    <div class="tab-content" id="usersTab">
      <div class="data-table">
        <div class="table-header">
          <h2>Registered Users</h2>
        </div>
        <table>
          <thead>
            <tr>
              <th>Email</th>
              <th>Name</th>
              <th>Role</th>
              <th>Verified</th>
              <th>Joined</th>
            </tr>
          </thead>
          <tbody id="usersTable">
            <tr><td colspan="5" class="empty-state">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Reservations Tab -->
    <div class="tab-content" id="reservationsTab">
      <div class="data-table">
        <div class="table-header">
          <h2>All Reservations</h2>
        </div>
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Station</th>
              <th>Time</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="reservationsTable">
            <tr><td colspan="5" class="empty-state">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Transactions Tab -->
    <div class="tab-content" id="transactionsTab">
      <div class="data-table">
        <div class="table-header">
          <h2>Recent Transactions</h2>
          <button class="btn btn-secondary" onclick="exportTransactions()">üì• Export CSV</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>User</th>
              <th>Type</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody id="transactionsTable">
            <tr><td colspan="4" class="empty-state">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- Demo Controls Tab -->
    <div class="tab-content" id="demoTab">
      <div class="data-table">
        <div class="table-header">
          <h2>Demo Simulation Controls</h2>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btn-success" onclick="setupDemo()">Setup Full Demo</button>
            <button class="btn btn-danger" onclick="resetDemo()">Reset All</button>
          </div>
        </div>
        <div id="demoStatus" style="padding:12px 15px;background:#e8f5e9;border-radius:8px;margin:0 15px 15px;font-size:14px;display:none;color:#2e7d32"></div>
        <table>
          <thead>
            <tr>
              <th>Station</th>
              <th>Connection</th>
              <th>Status</th>
              <th>Live Data</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="demoTable">
            <tr><td colspan="5" class="empty-state">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Station Modal -->
  <div class="modal" id="stationModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="stationModalTitle">Add Station</h3>
        <button class="close-btn" onclick="closeStationModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="stationForm" onsubmit="saveStation(event)">
          <div class="form-group">
            <label>Station ID</label>
            <input type="text" id="stationId" required>
          </div>
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="stationName" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Power (kW)</label>
              <input type="number" id="stationPower" required min="1" step="0.1">
            </div>
            <div class="form-group">
              <label>Price/kWh (‚Ç¨)</label>
              <input type="number" id="stationPrice" required min="0.01" step="0.01" value="0.35">
            </div>
          </div>
          <div class="form-group">
            <label>Location <small style="color:#888">(search address or click map)</small></label>
            <div style="display:flex;gap:6px;margin-bottom:8px">
              <input type="text" id="mapSearchInput" placeholder="Search address..." style="flex:1" onkeydown="if(event.key==='Enter'){event.preventDefault();searchAddress()}">
              <button type="button" class="btn btn-secondary" style="padding:6px 14px;white-space:nowrap" onclick="searchAddress()">Search</button>
            </div>
            <div id="stationMapPicker" style="height:220px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px;z-index:1"></div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Latitude</label>
              <input type="number" id="stationLat" required step="any">
            </div>
            <div class="form-group">
              <label>Longitude</label>
              <input type="number" id="stationLng" required step="any">
            </div>
          </div>
          <div class="form-group">
            <label>Address</label>
            <input type="text" id="stationAddress">
          </div>
          <div class="form-group">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="stationHardware" style="width:auto;margin:0">
              Real Hardware Charger
            </label>
            <small style="color:#888;display:block;margin-top:4px">Enable for chargers with real OCPP hardware (tries real connection before simulation fallback)</small>
          </div>
          <button type="submit" class="btn btn-success" style="width: 100%;">Save Station</button>
        </form>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Auth check - require admin role
    const authToken = localStorage.getItem('accessToken');
    const user = JSON.parse(localStorage.getItem('user') || '{}');

    if (!authToken || user.role !== 'admin') {
      window.location.href = '/login.html';
    }

    // Admin toast notification
    let _adminToastTimer = null;
    function showAdminToast(message, type) {
      let toast = document.getElementById('adminToast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'adminToast';
        toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:10px;color:white;font-size:14px;font-weight:500;z-index:9999;transition:opacity 0.3s;box-shadow:0 4px 12px rgba(0,0,0,0.15);cursor:pointer;';
        toast.onclick = function() { toast.style.opacity = '0'; };
        document.body.appendChild(toast);
      }
      toast.style.background = type === 'error' ? '#f44336' : '#4CAF50';
      toast.textContent = message;
      toast.style.opacity = '1';
      if (_adminToastTimer) clearTimeout(_adminToastTimer);
      _adminToastTimer = setTimeout(function() { toast.style.opacity = '0'; }, 3000);
    }

    // Verify token server-side
    (async () => {
      try {
        const res = await fetch('/api/auth/me', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (!res.ok) {
          localStorage.clear();
          window.location.href = '/login.html';
        } else {
          const data = await res.json();
          if (data.user && data.user.role !== 'admin') {
            window.location.href = '/';
          }
        }
      } catch (e) { /* allow offline with cached token */ }
    })();

    function getAuthHeaders() {
      return {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json'
      };
    }

    function logout() {
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      localStorage.removeItem('user');
      window.location.href = '/login.html';
    }

    // Tab switching
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName + 'Tab').classList.add('active');
      
      // Load data for tab
      if (tabName === 'users') loadUsers();
      if (tabName === 'reservations') loadReservations();
      if (tabName === 'transactions') loadTransactions();
      if (tabName === 'demo') loadDemoControls();
    }

    // Load stations
    async function loadStations() {
      try {
        const response = await fetch('/api/stations');
        const stations = await response.json();
        
        document.getElementById('totalStations').textContent = stations.length;
        document.getElementById('chargingCount').textContent = 
          stations.filter(s => s.currentTransaction).length;
        
        const tbody = document.getElementById('stationsTable');
        if (stations.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No stations</td></tr>';
          return;
        }
        
        tbody.innerHTML = stations.map(s => {
          let statusClass = 'status-offline';
          let statusText = 'Offline';
          if (s.connected) {
            statusClass = s.currentTransaction ? 'status-charging' : 'status-online';
            statusText = s.currentTransaction ? 'Charging' : 'Available';
          }

          return `
            <tr>
              <td data-label="ID"><strong>${s.id}</strong></td>
              <td data-label="Name">${s.name}</td>
              <td data-label="Status"><span class="status-badge ${statusClass}">${statusText}</span></td>
              <td data-label="Power">${s.power} kW</td>
              <td data-label="Session">${s.currentTransaction ? `‚ö° ${s.currentTransaction.idTag}` : '‚Äî'}</td>
              <td data-label="">
                <button class="btn btn-small btn-success" onclick="editStation('${s.id}')">Edit</button>
                ${s.currentTransaction ? `<button class="btn btn-small btn-danger" onclick="stopCharging('${s.id}')">Stop</button>` : `<button class="btn btn-small btn-danger" onclick="deleteStation('${s.id}')">Delete</button>`}
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        console.error('Failed to load stations:', error);
      }
    }

    // Load users
    async function loadUsers() {
      try {
        const response = await fetch('/api/users/all', { headers: getAuthHeaders() });
        const data = await response.json();
        document.getElementById('totalUsers').textContent = data.users.length;
        const tbody = document.getElementById('usersTable');
        if (data.users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No users</td></tr>';
          return;
        }
        tbody.innerHTML = data.users.map(u => {
          const date = new Date(u.createdAt).toLocaleDateString();
          return `<tr>
            <td data-label="Email">${u.email}</td>
            <td data-label="Name">${u.firstName || ''} ${u.lastName || ''}</td>
            <td data-label="Role"><span class="status-badge ${u.role === 'admin' ? 'status-charging' : 'status-online'}">${u.role}</span></td>
            <td data-label="Verified">${u.emailVerified ? '‚úì' : '‚úó'}</td>
            <td data-label="Joined">${date}</td>
          </tr>`;
        }).join('');
      } catch (error) {
        console.error('Failed to load users:', error);
      }
    }

    // Load reservations
    async function loadReservations() {
      try {
        const response = await fetch('/api/reservations/all', {
          headers: getAuthHeaders()
        });
        const reservations = await response.json();
        
        document.getElementById('activeReservations').textContent = 
          reservations.filter(r => r.status === 'active').length;
        
        const tbody = document.getElementById('reservationsTable');
        if (reservations.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No reservations</td></tr>';
          return;
        }
        
        tbody.innerHTML = reservations.map(r => {
          const start = new Date(r.startTime);
          const end = new Date(r.endTime);
          return `
            <tr>
              <td data-label="User">${r.userEmail || r.userId}</td>
              <td data-label="Station">${r.chargerId}</td>
              <td data-label="Time">${start.toLocaleString()} - ${end.toLocaleTimeString()}</td>
              <td data-label="Status"><span class="status-badge status-${r.status}">${r.status}</span></td>
              <td data-label="">
                ${r.status === 'active' ? `<button class="btn btn-small btn-danger" onclick="cancelReservation('${r.id}')">Cancel</button>` : '‚Äî'}
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        console.error('Failed to load reservations:', error);
      }
    }

    // Load transactions
    async function loadTransactions() {
      try {
        const response = await fetch('/api/wallet/all-transactions', {
          headers: getAuthHeaders()
        });
        const data = await response.json();
        
        // Calculate today's revenue
        const today = new Date().toDateString();
        const todayRevenue = data.transactions
          .filter(t => t.type === 'payment' && new Date(t.timestamp).toDateString() === today)
          .reduce((sum, t) => sum + Math.abs(t.amount), 0);
        document.getElementById('todayRevenue').textContent = `‚Ç¨${todayRevenue.toFixed(2)}`;
        
        const tbody = document.getElementById('transactionsTable');
        if (!data.transactions || data.transactions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="empty-state">No transactions</td></tr>';
          return;
        }
        
        tbody.innerHTML = data.transactions.slice(0, 20).map(t => {
          const date = new Date(t.timestamp);
          const isTopUp = t.type === 'topup';
          return `
            <tr>
              <td data-label="Date">${date.toLocaleString()}</td>
              <td data-label="User">${t.userId}</td>
              <td data-label="Type">${isTopUp ? 'üí∞ Top Up' : '‚ö° Charging'}</td>
              <td data-label="Amount" style="color: ${isTopUp ? '#2e7d32' : '#333'}; font-weight: 600;">
                ${isTopUp ? '+' : '-'}‚Ç¨${Math.abs(t.amount).toFixed(2)}
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        console.error('Failed to load transactions:', error);
      }
    }

    // Station modal
    function openStationModal() {
      editingStationId = null;
      document.getElementById('stationModalTitle').textContent = 'Add Station';
      document.getElementById('stationForm').reset();
      document.getElementById('stationId').readOnly = false;
      document.getElementById('stationModal').classList.add('show');
      initMapPicker(null, null);
    }

    function closeStationModal() {
      document.getElementById('stationModal').classList.remove('show');
      if (pickerMap) {
        pickerMap.remove();
        pickerMap = null;
        pickerMarker = null;
      }
    }

    let editingStationId = null;
    let pickerMap = null;
    let pickerMarker = null;

    function initMapPicker(lat, lng) {
      // Destroy previous map instance if exists
      if (pickerMap) {
        pickerMap.remove();
        pickerMap = null;
        pickerMarker = null;
      }

      const defaultLat = lat || 41.9981;
      const defaultLng = lng || 21.4314;

      // Small delay to ensure modal is visible and container has dimensions
      setTimeout(() => {
        pickerMap = L.map('stationMapPicker').setView([defaultLat, defaultLng], lat ? 16 : 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OSM'
        }).addTo(pickerMap);

        // Add marker if coordinates exist
        if (lat && lng) {
          pickerMarker = L.marker([lat, lng]).addTo(pickerMap);
        }

        // Click to set location
        pickerMap.on('click', function(e) {
          const { lat, lng } = e.latlng;
          document.getElementById('stationLat').value = lat.toFixed(6);
          document.getElementById('stationLng').value = lng.toFixed(6);

          if (pickerMarker) {
            pickerMarker.setLatLng(e.latlng);
          } else {
            pickerMarker = L.marker(e.latlng).addTo(pickerMap);
          }
        });

        pickerMap.invalidateSize();
      }, 100);
    }

    async function searchAddress() {
      const query = document.getElementById('mapSearchInput').value.trim();
      if (!query) return;

      try {
        const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(query));
        const results = await res.json();
        if (results.length === 0) {
          showAdminToast('Address not found. Try a different search.', 'error');
          return;
        }

        const { lat, lon, display_name } = results[0];
        const latNum = parseFloat(lat);
        const lngNum = parseFloat(lon);

        document.getElementById('stationLat').value = latNum.toFixed(6);
        document.getElementById('stationLng').value = lngNum.toFixed(6);
        document.getElementById('stationAddress').value = display_name;

        if (pickerMap) {
          pickerMap.setView([latNum, lngNum], 17);
          if (pickerMarker) {
            pickerMarker.setLatLng([latNum, lngNum]);
          } else {
            pickerMarker = L.marker([latNum, lngNum]).addTo(pickerMap);
          }
        }
      } catch (err) {
        showAdminToast('Search failed. Check your internet connection.', 'error');
      }
    }

    function editStation(id) {
      editingStationId = id;
      document.getElementById('stationModalTitle').textContent = 'Edit Station';

      // Fetch station data
      fetch(`/api/stations/${encodeURIComponent(id)}`)
        .then(r => r.json())
        .then(s => {
          document.getElementById('stationId').value = s.id;
          document.getElementById('stationId').readOnly = false;
          document.getElementById('stationName').value = s.name || '';
          document.getElementById('stationPower').value = s.power || '';
          document.getElementById('stationPrice').value = s.pricePerKwh || 0.35;
          document.getElementById('stationLat').value = s.lat || '';
          document.getElementById('stationLng').value = s.lng || '';
          document.getElementById('stationAddress').value = s.address || '';
          document.getElementById('stationHardware').checked = !!s.isHardware;
          document.getElementById('stationModal').classList.add('show');
          initMapPicker(s.lat, s.lng);
        })
        .catch(() => showAdminToast('Failed to load station', 'error'));
    }

    async function saveStation(e) {
      e.preventDefault();

      const data = {
        id: document.getElementById('stationId').value.trim(),
        name: document.getElementById('stationName').value.trim(),
        power: parseFloat(document.getElementById('stationPower').value),
        pricePerKwh: parseFloat(document.getElementById('stationPrice').value),
        lat: parseFloat(document.getElementById('stationLat').value),
        lng: parseFloat(document.getElementById('stationLng').value),
        address: document.getElementById('stationAddress').value.trim(),
        isHardware: document.getElementById('stationHardware').checked
      };

      try {
        let response;
        if (editingStationId) {
          // If ID changed, include newId in payload
          if (data.id !== editingStationId) {
            data.newId = data.id;
          }
          // Update existing
          response = await fetch(`/api/stations/${encodeURIComponent(editingStationId)}`, {
            method: 'PUT',
            headers: getAuthHeaders(),
            body: JSON.stringify(data)
          });
        } else {
          // Create new
          response = await fetch('/api/stations', {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify(data)
          });
        }

        if (!response.ok) {
          const err = await response.json();
          showAdminToast(err.error || 'Failed to save station', 'error');
          return;
        }

        closeStationModal();
        loadStations();
        showAdminToast('Station saved successfully');
      } catch (error) {
        showAdminToast('Network error saving station', 'error');
      }
    }

    async function deleteStation(id) {
      if (!confirm(`Delete station ${id}? This cannot be undone.`)) return;

      try {
        const response = await fetch(`/api/stations/${encodeURIComponent(id)}`, {
          method: 'DELETE',
          headers: getAuthHeaders()
        });
        if (!response.ok) {
          const err = await response.json();
          showAdminToast(err.error || 'Failed to delete', 'error');
          return;
        }
        loadStations();
        showAdminToast('Station deleted');
      } catch (error) {
        showAdminToast('Failed to delete station', 'error');
      }
    }

    async function stopCharging(stationId) {
      if (!confirm('Stop charging session?')) return;
      
      try {
        await fetch(`/api/stations/${encodeURIComponent(stationId)}/stop`, {
          method: 'POST',
          headers: getAuthHeaders()
        });
        loadStations();
      } catch (error) {
        showAdminToast('Failed to stop charging', 'error');
      }
    }

    async function cancelReservation(id) {
      if (!confirm('Cancel this reservation?')) return;
      
      try {
        await fetch(`/api/reservations/${id}/cancel`, {
          method: 'POST',
          headers: getAuthHeaders()
        });
        loadReservations();
      } catch (error) {
        showAdminToast('Failed to cancel', 'error');
      }
    }

    function exportTransactions() {
      showAdminToast('Export feature coming soon');
    }

    // === Demo Controls ===
    async function loadDemoControls() {
      try {
        const [stationsRes, simRes] = await Promise.all([
          fetch('/api/stations'),
          fetch('/api/simulate/status', { headers: getAuthHeaders() })
        ]);
        const stations = await stationsRes.json();
        const simStatus = simRes.ok ? await simRes.json() : { activeSimulations: [] };

        const simMap = {};
        simStatus.activeSimulations.forEach(s => { simMap[s.stationId] = s; });

        const tbody = document.getElementById('demoTable');
        tbody.innerHTML = stations.map(s => {
          const sim = simMap[s.id];
          const isSimulated = s.connectionSource === 'simulation';
          const isRealOCPP = s.connectionSource === 'ocpp' && s.connected;
          const isCitrine = s.connectionSource === 'citrineos' && s.connected;
          const isCharging = !!s.currentTransaction;

          let connBadge = '<span style="color:#999">Offline</span>';
          if (isRealOCPP) connBadge = '<span style="color:#1976d2;font-weight:600">OCPP</span>';
          else if (isCitrine) connBadge = '<span style="color:#7b1fa2;font-weight:600">CitrineOS</span>';
          else if (isSimulated && s.connected) connBadge = '<span style="color:#388e3c;font-weight:600">Simulated</span>';

          let statusText = s.status || 'Offline';
          let statusColor = '#999';
          if (isCharging) { statusText = 'Charging'; statusColor = '#f9a825'; }
          else if (s.connected) { statusColor = '#388e3c'; }

          let liveData = '-';
          if (isCharging && s.currentTransaction) {
            const tx = s.currentTransaction;
            const pKw = tx.power ? (tx.power / 1000).toFixed(1) : '0';
            liveData = pKw + ' kW | ' + (tx.energy || '0') + ' kWh | SoC: ' + (tx.soc ? Math.round(tx.soc) : '?') + '%';
          }

          let actions = '';
          if (isRealOCPP || isCitrine) {
            actions = '<span style="color:#888;font-size:12px">Real connection</span>';
          } else if (!s.connected) {
            actions = '<button class="btn btn-success" style="padding:4px 10px;font-size:12px" onclick="simConnect(\'' + s.id + '\')">Connect</button>';
          } else if (s.connected && !isCharging) {
            actions = '<button class="btn btn-success" style="padding:4px 10px;font-size:12px;margin-right:5px" onclick="simStart(\'' + s.id + '\')">Start</button>' +
              '<button class="btn btn-secondary" style="padding:4px 10px;font-size:12px" onclick="simDisconnect(\'' + s.id + '\')">Off</button>';
          } else if (isCharging) {
            actions = '<button class="btn btn-danger" style="padding:4px 10px;font-size:12px" onclick="simStop(\'' + s.id + '\')">Stop</button>';
          }

          return '<tr>' +
            '<td data-label="Station"><strong>' + s.id + '</strong><br><small>' + (s.name || '') + '</small></td>' +
            '<td data-label="Connection">' + connBadge + '</td>' +
            '<td data-label="Status" style="color:' + statusColor + ';font-weight:600">' + statusText + '</td>' +
            '<td data-label="Live Data" style="font-size:12px">' + liveData + '</td>' +
            '<td data-label="Actions">' + actions + '</td>' +
          '</tr>';
        }).join('');
      } catch (err) {
        console.error('Failed to load demo controls:', err);
      }
    }

    async function simConnect(id) {
      await fetch('/api/simulate/connect/' + encodeURIComponent(id), { method: 'POST', headers: getAuthHeaders() });
      showDemoStatus('Connected station ' + id);
      loadDemoControls();
    }

    async function simStart(id) {
      await fetch('/api/simulate/start/' + encodeURIComponent(id), { method: 'POST', headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' }, body: '{}' });
      showDemoStatus('Started charging on ' + id);
      loadDemoControls();
    }

    async function simStop(id) {
      await fetch('/api/simulate/stop/' + encodeURIComponent(id), { method: 'POST', headers: getAuthHeaders() });
      showDemoStatus('Stopped charging on ' + id);
      loadDemoControls();
    }

    async function simDisconnect(id) {
      await fetch('/api/simulate/disconnect/' + encodeURIComponent(id), { method: 'POST', headers: getAuthHeaders() });
      showDemoStatus('Disconnected station ' + id);
      loadDemoControls();
    }

    async function setupDemo() {
      if (!confirm('Connect all offline stations and start a sample charging session?')) return;
      const res = await fetch('/api/simulate/demo-setup', { method: 'POST', headers: getAuthHeaders() });
      const data = await res.json();
      showDemoStatus('Demo setup complete: ' + data.results.length + ' stations configured');
      loadDemoControls();
      loadStations();
    }

    async function resetDemo() {
      if (!confirm('Disconnect all simulated stations? Real connections unaffected.')) return;
      const stationsRes = await fetch('/api/stations');
      const stations = await stationsRes.json();
      for (const s of stations) {
        if (s.connectionSource === 'simulation') {
          await fetch('/api/simulate/disconnect/' + encodeURIComponent(s.id), { method: 'POST', headers: getAuthHeaders() });
        }
      }
      showDemoStatus('All simulations stopped');
      loadDemoControls();
      loadStations();
    }

    function showDemoStatus(msg) {
      const el = document.getElementById('demoStatus');
      el.style.display = 'block';
      el.textContent = msg;
      setTimeout(() => { el.style.display = 'none'; }, 3000);
    }

    // Initial load
    loadStations();
    loadTransactions();

    // Refresh every 10 seconds
    setInterval(() => {
      loadStations();
      if (document.getElementById('reservationsTab').classList.contains('active')) {
        loadReservations();
      }
      if (document.getElementById('transactionsTab').classList.contains('active')) {
        loadTransactions();
      }
      if (document.getElementById('demoTab').classList.contains('active')) {
        loadDemoControls();
      }
    }, 10000);
  </script>
</body>
</html>
