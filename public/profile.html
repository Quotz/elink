<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#7CB342">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>My Profile - eLink</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    body {
      background: var(--gray-100);
      min-height: 100vh;
      min-height: 100dvh;
      overflow-y: auto;
      padding-bottom: calc(var(--bottom-nav-height) + 20px);
    }
    .profile-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 20px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .profile-header h1 { font-size: 20px; font-weight: 700; }
    .header-actions { display: flex; gap: 8px; }
    .btn-small {
      padding: 8px 14px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: rgba(255,255,255,0.2);
      color: white;
      min-height: 36px;
      transition: background 0.2s;
    }
    .btn-small:active { background: rgba(255,255,255,0.3); }
    .container {
      max-width: 600px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      background: white;
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 14px;
      box-shadow: var(--shadow);
    }
    .card-title {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 14px;
      color: var(--gray-900);
    }
    .wallet-balance {
      text-align: center;
      padding: 24px 16px;
    }
    .balance-amount {
      font-size: 42px;
      font-weight: 700;
      color: var(--primary);
    }
    .balance-label {
      color: var(--gray-500);
      font-size: 13px;
      margin-top: 6px;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .user-avatar-lg {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 22px;
      font-weight: 600;
      flex-shrink: 0;
    }
    .user-details h3 {
      font-size: 17px;
      font-weight: 600;
      color: var(--gray-900);
    }
    .user-details p {
      font-size: 13px;
      color: var(--gray-500);
      margin-top: 3px;
    }
    .user-role {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      margin-top: 4px;
      background: #e8f5e9;
      color: #2e7d32;
    }
    .reservation-item {
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 10px;
    }
    .reservation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .reservation-station { font-weight: 600; color: var(--gray-900); font-size: 14px; }
    .reservation-status {
      padding: 3px 10px;
      border-radius: 16px;
      font-size: 11px;
      font-weight: 600;
    }
    .status-active { background: #e8f5e9; color: #2e7d32; }
    .status-completed { background: #e3f2fd; color: #1565c0; }
    .status-cancelled { background: #ffebee; color: #c62828; }
    .reservation-time { font-size: 13px; color: var(--gray-500); }
    .empty-state {
      text-align: center;
      padding: 30px 16px;
      color: var(--gray-500);
      font-size: 14px;
    }
    .transaction-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid var(--gray-100);
      min-height: 44px;
    }
    .transaction-item:last-child { border-bottom: none; }
    .transaction-type { font-weight: 500; color: var(--gray-900); font-size: 14px; }
    .transaction-date { font-size: 12px; color: var(--gray-500); margin-top: 3px; }
    .transaction-amount { font-weight: 700; font-size: 15px; }
    .amount-positive { color: #2e7d32; }
    .amount-negative { color: var(--gray-900); }
    .amount-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    .amount-btn {
      padding: 14px;
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      background: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 48px;
    }
    .amount-btn:active, .amount-btn.selected {
      border-color: var(--primary);
      background: #f1f8e9;
      color: var(--primary-dark);
    }
    .admin-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px;
      background: var(--gray-100);
      border-radius: 10px;
      color: var(--gray-700);
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      transition: background 0.2s;
      min-height: 48px;
    }
    .admin-link:active { background: var(--gray-200); }
    .logout-btn {
      width: 100%;
      padding: 14px;
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-sm);
      background: white;
      color: var(--danger);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      min-height: 48px;
    }
    .logout-btn:active { background: #ffebee; border-color: var(--danger); }

    /* Bottom nav for profile page */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--bottom-nav-height);
      background: white;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.08);
      z-index: 1002;
      padding-bottom: env(safe-area-inset-bottom, 0);
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding: 6px 16px;
      border: none;
      background: none;
      cursor: pointer;
      color: var(--gray-500);
      font-size: 10px;
      font-weight: 500;
      min-width: 64px;
      min-height: 44px;
      justify-content: center;
    }
    .nav-item.active { color: var(--primary); }
    .nav-item:active { opacity: 0.7; }

    @supports (padding-top: env(safe-area-inset-top)) {
      .profile-header { padding-top: max(20px, env(safe-area-inset-top)); }
      .bottom-nav {
        padding-bottom: env(safe-area-inset-bottom);
        height: calc(var(--bottom-nav-height) + env(safe-area-inset-bottom));
      }
    }
  </style>
</head>
<body>
  <header class="profile-header">
    <h1 data-i18n="profile">My Profile</h1>
    <div class="header-actions">
      <button class="btn-small" id="langToggle" onclick="toggleLanguage();refreshProfilePage()">MK</button>
      <button class="btn-small" id="currencyToggle" onclick="toggleCurrency();refreshProfilePage()">MKD</button>
      <button class="btn-small" onclick="window.location.href='/'">‚Üê <span data-i18n="back_to_map">Map</span></button>
    </div>
  </header>

  <div class="container">
    <!-- User Info -->
    <div class="card">
      <div class="user-info">
        <div class="user-avatar-lg" id="userAvatar">U</div>
        <div class="user-details">
          <h3 id="userName">User</h3>
          <p id="userEmail">email@example.com</p>
          <span class="user-role" id="userRole" style="display:none"></span>
        </div>
      </div>
    </div>

    <!-- Admin Link (shown if admin) -->
    <a href="/admin.html" class="admin-link hidden" id="adminLink">
      ‚öôÔ∏è <span data-i18n="admin_panel_link">Admin Panel ‚Äî Manage stations & users</span>
    </a>

    <!-- Wallet -->
    <div class="card">
      <h2 class="card-title" data-i18n="wallet">Wallet</h2>
      <div class="wallet-balance">
        <div class="balance-amount" id="balanceAmount">‚Ç¨0.00</div>
        <div class="balance-label" data-i18n="balance">Available Balance</div>
      </div>
      <button class="btn btn-primary btn-full" onclick="showTopUpModal()" data-i18n="top_up">+ Add Funds</button>
    </div>

    <!-- Reservations -->
    <div class="card">
      <h2 class="card-title" data-i18n="my_reservations">My Reservations</h2>
      <div id="reservationsList">
        <div class="empty-state" data-i18n="no_reservations">No reservations yet</div>
      </div>
    </div>

    <!-- Recent Transactions -->
    <div class="card">
      <h2 class="card-title" data-i18n="recent_transactions">Recent Transactions</h2>
      <div id="transactionsList">
        <div class="empty-state" data-i18n="no_transactions">No transactions yet</div>
      </div>
    </div>

    <!-- Charging History -->
    <div class="card">
      <h2 class="card-title" data-i18n="charging_history">Charging History</h2>
      <div id="chargingHistoryList">
        <div class="empty-state" data-i18n="no_charging_sessions">No charging sessions yet</div>
      </div>
    </div>

    <!-- Logout -->
    <button class="logout-btn" onclick="logout()">üö™ <span data-i18n="logout">Log Out</span></button>
    <div style="height:20px"></div>
  </div>

  <!-- Top Up Modal -->
  <div class="modal hidden" id="topUpModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 data-i18n="add_funds">Add Funds</h3>
        <button class="close-btn" onclick="hideTopUpModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="amount-options" id="amountOptions"></div>
        <button class="btn btn-primary btn-full" id="topUpBtn" onclick="processTopUp()" disabled>
          <span data-i18n="select_amount">Select Amount</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div class="modal hidden" id="paymentModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 data-i18n="payment">Payment</h3>
        <button class="close-btn" onclick="hidePaymentModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p style="margin-bottom:16px;color:var(--gray-600);"><span data-i18n="top_up_amount">Top up</span> <span id="paymentAmount">‚Ç¨0</span></p>
        <div style="background:var(--gray-100);padding:18px;border-radius:10px;text-align:center;margin-bottom:16px">
          <p style="color:var(--gray-500);font-size:13px" data-i18n="secure_payment_demo">Secure Payment (Demo)</p>
          <p style="margin-top:8px;font-family:monospace;font-size:16px;color:var(--gray-700)">**** **** **** 4242</p>
        </div>
        <button class="btn btn-primary btn-full" id="payNowBtn" onclick="confirmTopUp()">
          <span data-i18n="pay_now">Pay Now</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottom-nav">
    <button class="nav-item" onclick="window.location.href='/'">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
      <span data-i18n="map">Map</span>
    </button>
    <button class="nav-item" onclick="window.location.href='/'">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <span data-i18n="search">Search</span>
    </button>
    <button class="nav-item active">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span data-i18n="profile">Profile</span>
    </button>
  </nav>

  <script src="/i18n.js"></script>
  <script src="/js/toast.js"></script>
  <script>
    let currentUser = null;
    let selectedAmount = 0;
    let authToken = localStorage.getItem('accessToken');

    if (!authToken) {
      window.location.href = '/login.html';
    }

    function getAuthHeaders() {
      return {
        'Authorization': `Bearer ${authToken}`,
        'Content-Type': 'application/json'
      };
    }

    async function loadUserData() {
      const userStr = localStorage.getItem('user');
      if (userStr) {
        currentUser = JSON.parse(userStr);
        document.getElementById('userName').textContent =
          `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim() || 'User';
        document.getElementById('userEmail').textContent = currentUser.email;
        document.getElementById('userAvatar').textContent =
          (currentUser.firstName?.[0] || currentUser.email[0]).toUpperCase();

        if (currentUser.role === 'admin') {
          const roleEl = document.getElementById('userRole');
          roleEl.textContent = t('admin');
          roleEl.style.display = '';
          document.getElementById('adminLink').classList.remove('hidden');
        }
      }
    }

    async function loadBalance() {
      try {
        const response = await fetch('/api/wallet/balance', { headers: getAuthHeaders() });
        const data = await response.json();
        const balEl = document.getElementById('balanceAmount');
        const bal = Number(data.balance) || 0;
        balEl.textContent = typeof formatPrice === 'function' ? formatPrice(bal) : `‚Ç¨${bal.toFixed(2)}`;
      } catch (error) {
        console.error('Failed to load balance:', error);
      }
    }

    async function loadReservations() {
      try {
        const response = await fetch('/api/reservations/my', { headers: getAuthHeaders() });
        const data = await response.json();

        const container = document.getElementById('reservationsList');
        if (data.length === 0) {
          container.innerHTML = `<div class="empty-state">${t('no_reservations')}</div>`;
          return;
        }

        container.innerHTML = data.map(r => {
          const start = new Date(r.startTime);
          const end = new Date(r.endTime);
          const dateStr = start.toLocaleDateString();
          const timeStr = `${start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;

          return `
            <div class="reservation-item">
              <div class="reservation-header">
                <span class="reservation-station">${t('charger')} ${r.chargerId}</span>
                <span class="reservation-status status-${r.status}">${r.status}</span>
              </div>
              <div class="reservation-time">${dateStr} ¬∑ ${timeStr}</div>
              ${r.status === 'active' ? `<button class="btn btn-danger" style="margin-top:10px;padding:8px;font-size:13px" onclick="cancelReservation('${r.id}')">${t('cancel')}</button>` : ''}
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Failed to load reservations:', error);
      }
    }

    async function loadChargingHistory() {
      try {
        const response = await fetch('/api/users/charging-history', { headers: getAuthHeaders() });
        const data = await response.json();

        const container = document.getElementById('chargingHistoryList');
        if (!data.history || data.history.length === 0) {
          container.innerHTML = `<div class="empty-state">${t('no_charging_sessions')}</div>`;
          return;
        }

        container.innerHTML = data.history.slice(0, 10).map(session => {
          const date = new Date(session.startTime).toLocaleDateString();
          const duration = session.endTime
            ? Math.round((new Date(session.endTime) - new Date(session.startTime)) / 60000) + ' min'
            : t('in_progress');
          const energy = session.totalKwh ? session.totalKwh.toFixed(2) + ' kWh' : 'N/A';
          const cost = session.totalCost ? formatPrice(session.totalCost) : 'N/A';

          return `<div class="transaction-item">
              <div>
                <div class="transaction-type">${t('charger')} ${session.chargerId}</div>
                <div class="transaction-date">${date} ¬∑ ${duration} ¬∑ ${energy}</div>
              </div>
              <div class="transaction-amount">${cost}</div>
            </div>`;
        }).join('');
      } catch (error) {
        console.error('Failed to load charging history:', error);
      }
    }

    async function loadTransactions() {
      try {
        const response = await fetch('/api/wallet/transactions', { headers: getAuthHeaders() });
        const data = await response.json();

        const container = document.getElementById('transactionsList');
        if (!data.transactions || data.transactions.length === 0) {
          container.innerHTML = `<div class="empty-state">${t('no_transactions')}</div>`;
          return;
        }

        container.innerHTML = data.transactions.slice(0, 5).map(tx => {
          const isTopUp = tx.type === 'topup';
          const amountClass = isTopUp ? 'amount-positive' : 'amount-negative';
          const sign = isTopUp ? '+' : '';
          const date = new Date(tx.timestamp).toLocaleDateString();

          return `
            <div class="transaction-item">
              <div>
                <div class="transaction-type">${isTopUp ? t('top_up_label') : t('charging_payment')}</div>
                <div class="transaction-date">${date}</div>
              </div>
              <div class="transaction-amount ${amountClass}">${sign}${formatPrice(Math.abs(tx.amount))}</div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Failed to load transactions:', error);
      }
    }

    const TOP_UP_AMOUNTS = [10, 20, 50, 100, 200, 500]; // EUR values

    function renderTopUpAmounts() {
      const container = document.getElementById('amountOptions');
      if (!container) return;
      container.innerHTML = TOP_UP_AMOUNTS.map(amt =>
        `<button class="amount-btn" onclick="selectAmount(${amt}, this)">${formatPrice(amt)}</button>`
      ).join('');
    }

    function showTopUpModal() {
      selectedAmount = 0;
      renderTopUpAmounts();
      const topUpBtn = document.getElementById('topUpBtn');
      topUpBtn.querySelector('[data-i18n]').textContent = t('select_amount');
      topUpBtn.disabled = true;
      document.getElementById('topUpModal').classList.remove('hidden');
    }

    function hideTopUpModal() {
      document.getElementById('topUpModal').classList.add('hidden');
    }

    function selectAmount(amount, el) {
      selectedAmount = amount;
      document.querySelectorAll('.amount-btn').forEach(btn => btn.classList.remove('selected'));
      if (el) el.classList.add('selected');
      const topUpBtn = document.getElementById('topUpBtn');
      topUpBtn.querySelector('[data-i18n]').textContent = `${t('add_funds')} ${formatPrice(amount)}`;
      topUpBtn.disabled = false;
    }

    function processTopUp() {
      hideTopUpModal();
      document.getElementById('paymentAmount').textContent = formatPrice(selectedAmount);
      document.getElementById('paymentModal').classList.remove('hidden');
    }

    function hidePaymentModal() {
      document.getElementById('paymentModal').classList.add('hidden');
    }

    async function confirmTopUp() {
      const btn = document.getElementById('payNowBtn');
      btn.disabled = true;
      btn.querySelector('[data-i18n]').textContent = t('processing');

      try {
        const response = await fetch('/api/wallet/topup', {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ amount: selectedAmount, paymentMethod: 'card' })
        });

        if (response.ok) {
          hidePaymentModal();
          loadBalance();
          loadTransactions();
          showToast(t('payment_successful'), 'success');
        } else {
          showToast(t('payment_failed_retry'), 'error');
        }
      } catch (error) {
        showToast(t('network_error'), 'error');
      } finally {
        btn.disabled = false;
        btn.querySelector('[data-i18n]').textContent = t('pay_now');
      }
    }

    async function cancelReservation(id) {
      if (!confirm(t('cancel_reservation'))) return;

      try {
        const response = await fetch(`/api/reservations/${id}/cancel`, {
          method: 'POST',
          headers: getAuthHeaders()
        });

        if (response.ok) {
          loadReservations();
        } else {
          showToast(t('failed_cancel_reservation'), 'error');
        }
      } catch (error) {
        showToast(t('network_error'), 'error');
      }
    }

    function logout() {
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      localStorage.removeItem('user');
      window.location.href = '/login.html';
    }

    function refreshProfilePage() {
      applyTranslations();
      updateToggleUI();
      loadUserData();
      loadBalance();
      loadReservations();
      loadTransactions();
      loadChargingHistory();
    }

    // Load all data
    loadUserData();
    loadBalance();
    loadReservations();
    loadTransactions();
    loadChargingHistory();

    setInterval(() => {
      loadBalance();
      loadReservations();
    }, 30000);
  </script>
</body>
</html>
